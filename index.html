<!DOCTYPE html>
<html lang="es">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Verificador de Mediciones</title>
<style>
:root{--bg:#000000;--card:#1a1a1a;--muted:#b0b0b0;--text:#ffffff;--accent:#00a9e0;--success:#00c853;--danger:#ff4444;--warning:#ffaa00;}
*{box-sizing:border-box;}body{margin:0;padding:24px;background:var(--bg);color:var(--text);font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
h1{margin:0 0 16px;font-size:24px;}h2{margin:0 0 12px;font-size:20px;}
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:20px;}
.stat-card{background:var(--card);border:1px solid #333;border-radius:8px;padding:14px;text-align:center;}
.stat-number{font-size:28px;font-weight:bold;margin:6px 0;}
.stat-label{color:var(--muted);font-size:13px;}
.tabs{display:flex;gap:8px;margin-bottom:20px;border-bottom:2px solid #333333;}
.tab{background:none;border:none;color:var(--muted);padding:12px 20px;cursor:pointer;font-size:16px;font-weight:600;border-bottom:3px solid transparent;}
.tab.active{color:var(--text);border-bottom-color:var(--accent);}
.tab-content{display:none;}.tab-content.active{display:block;}
.card{background:var(--card);border:1px solid #333333;border-radius:10px;padding:16px;margin-bottom:16px;}
.foto-viewer{display:grid;grid-template-columns:1fr;gap:12px;}
.foto-main{width:100%;max-height:500px;object-fit:contain;border-radius:8px;background:#0d0d0d;cursor:zoom-in;}
.foto-main.zoomed{cursor:zoom-out;transform:scale(1.8);transform-origin:center;transition:transform 0.3s;}
.foto-thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;}
.thumb{height:80px;border-radius:6px;object-fit:cover;cursor:pointer;border:2px solid transparent;}
.thumb.selected{border-color:var(--accent);}
.foto-compare{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:12px 0;padding:12px;background:#0a0a0a;border-radius:8px;}
.foto-compare img{width:100%;border-radius:8px;cursor:crosshair;}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;}
button{background:var(--accent);color:#ffffff;border:none;border-radius:8px;padding:10px 16px;cursor:pointer;font-weight:600;}
button.success{background:var(--success);color:#ffffff;}button.danger{background:var(--danger);color:#ffffff;}
button.secondary{background:#3d3d3d;color:var(--text);}
input[type=text],input[type=date],textarea{background:var(--card);border:1px solid #444444;color:var(--text);padding:10px;border-radius:8px;width:100%;}
.form-group{margin:12px 0;}.form-group label{display:block;margin-bottom:4px;color:var(--muted);font-size:14px;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;align-items:center;justify-content:center;}
.modal.active{display:flex;}.modal-content{background:var(--card);border-radius:10px;padding:24px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;}
</style>
</head>
<body>
<div id="pinModal" class="modal active">
<div class="modal-content">
<h2>Acceso Verificador</h2>
<div class="form-group"><label>PIN:</label><input id="pinInput" type="password" placeholder="Ingresa el PIN"/></div>
<button onclick="checkPin()">Ingresar</button>
</div>
</div>

<div id="app" style="display:none;">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
<h1>Verificador de Mediciones</h1>
<button onclick="refrescar()" style="background:var(--accent);padding:8px 16px;">üîÑ Refrescar</button>
</div>

<!-- Dashboard Global -->
<div class="dashboard">
<div class="stat-card"><div class="stat-label">Total Mediciones</div><div class="stat-number" id="globalTotal">0</div></div>
<div class="stat-card"><div class="stat-label">Pendientes Revisi√≥n</div><div class="stat-number" style="color:var(--warning);" id="globalPendientes">0</div></div>
<div class="stat-card"><div class="stat-label">Aprobados</div><div class="stat-number" style="color:var(--success);" id="globalAprobados">0</div></div>
<div class="stat-card"><div class="stat-label">Rechazados</div><div class="stat-number" style="color:var(--danger);" id="globalRechazados">0</div></div>
<div class="stat-card"><div class="stat-label">% Aprobaci√≥n</div><div class="stat-number" style="color:var(--accent);" id="globalAprobacion">0%</div></div>
</div>

<div class="tabs">
<button class="tab active" data-tab="pendientes">Pendientes de Revisi√≥n</button>
<button class="tab" data-tab="revisados">Revisados</button>
</div>
<div id="pendientes" class="tab-content active"></div>
<div id="revisados" class="tab-content">
<div class="card">
<h2>Exportar Revisi√≥n</h2>
<div style="display:grid;grid-template-columns:1fr 1fr auto auto;gap:8px;">
<div class="form-group"><label>Desde:</label><input id="exportFrom" type="date"/></div>
<div class="form-group"><label>Hasta:</label><input id="exportTo" type="date"/></div>
<button class="success" onclick="exportarRevision()">üì¶ ZIP + CSV</button>
<button class="success" onclick="exportarPDF()">üìÑ PDF</button>
</div>
</div>
<div id="revisadosList"></div>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const PIN='598393';
const WEBAPP_URL='https://script.google.com/macros/s/AKfycbyDnVKacuGsKljlzkotLUKN5StjW5XyQPl-2nm1FkIqGWGKbNkY36zCmPAb-Y2fr5tlbA/exec';
const firebaseConfig={apiKey:"AIzaSyCh8gYPHnQeYC3_SPV8QNctWVFAqYLMQeU",authDomain:"medicionesodn.firebaseapp.com",projectId:"medicionesodn",appId:"1:650664889209:web:193469c06809de2f653da8"};
try{firebase.initializeApp(firebaseConfig);}catch(e){}
const fbAuth=firebase.auth();const fbDb=firebase.firestore();
fbAuth.signInAnonymously().catch(console.error);

let isAuthenticated=false;
function checkPin(){const inp=document.getElementById('pinInput').value;if(inp===PIN){isAuthenticated=true;document.getElementById('pinModal').classList.remove('active');document.getElementById('app').style.display='block';init();}else{alert('PIN incorrecto');}}
function refrescar(){if(isAuthenticated){renderPendientes();renderRevisados();}}

let mediciones=[];
function init(){
fbDb.collection('mediciones').onSnapshot(snap=>{mediciones=snap.docs.map(d=>({id:d.id,...d.data()}));updateGlobalStats();renderPendientes();renderRevisados();});
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',e=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));e.target.classList.add('active');document.getElementById(e.target.dataset.tab).classList.add('active');}));

// Agregar event listeners para formatear inputs de medici√≥n
document.addEventListener('input', (e) => {
	if (e.target.id && e.target.id.startsWith('valor-')) {
		formatearMedicion(e.target);
	}
});
}

// Actualizar estad√≠sticas globales
function updateGlobalStats(){
const total=mediciones.length;
const pendientes=mediciones.filter(m=>m.estado==='pendiente_revision').length;
const aprobados=mediciones.filter(m=>m.estado==='medido').length;
const rechazados=mediciones.filter(m=>m.estado==='pendiente'&&m.observacion_rechazo).length;
const totalRevisados=aprobados+rechazados;
const pctAprobacion=totalRevisados>0?Math.round((aprobados/totalRevisados)*100):0;
document.getElementById('globalTotal').textContent=total;
document.getElementById('globalPendientes').textContent=pendientes;
document.getElementById('globalAprobados').textContent=aprobados;
document.getElementById('globalRechazados').textContent=rechazados;
document.getElementById('globalAprobacion').textContent=pctAprobacion+'%';
}

// Validar formato de medici√≥n: -25.00 a 5.00 con 2 decimales
function validarMedicion(valor) {
	if (!valor || valor.trim() === '') {
		return { valido: false, mensaje: 'Debe ingresar un valor de medici√≥n' };
	}
	
	// Verificar formato: n√∫mero opcionalmente negativo, punto, exactamente 2 decimales
	const regex = /^-?([0-4]?[0-9]|5)\.([0-9]{2})$/;
	if (!regex.test(valor)) {
		return { valido: false, mensaje: 'Formato inv√°lido. Use: -23.50 a 5.00 (ej: -22.45)' };
	}
	
	// Convertir a n√∫mero para verificar rango
	const num = parseFloat(valor);
	if (num < -23.50 || num > 5) {
		return { valido: false, mensaje: 'Valor fuera de rango. Debe estar entre -23.50 y 5.00' };
	}
	
	return { valido: true, valor: valor };
}

// Formatear valor de medici√≥n autom√°ticamente
function formatearMedicion(input) {
	let valor = input.value.replace(/[^0-9.-]/g, ''); // Solo n√∫meros, punto y gui√≥n
	
	// Si empieza con punto, agregar 0
	if (valor.startsWith('.')) {
		valor = '0' + valor;
	}
	
	// Si tiene m√°s de un punto, mantener solo el primero
	const puntos = valor.split('.');
	if (puntos.length > 2) {
		valor = puntos[0] + '.' + puntos.slice(1).join('');
	}
	
	// Limitar a 2 decimales
	if (puntos.length === 2 && puntos[1].length > 2) {
		valor = puntos[0] + '.' + puntos[1].substring(0, 2);
	}
	
	input.value = valor;
}

function renderPendientes(){
const pend=mediciones.filter(m=>m.estado==='pendiente_revision');
const el=document.getElementById('pendientes');el.innerHTML='';
if(!pend.length){el.innerHTML='<div class="card">No hay mediciones pendientes de revisi√≥n.</div>';return;}
pend.forEach(m=>el.appendChild(buildCard(m,true)));
}

function renderRevisados(){
const rev=mediciones.filter(m=>m.estado==='medido');
const el=document.getElementById('revisadosList');el.innerHTML='';
if(!rev.length){el.innerHTML='<div class="card">A√∫n no hay mediciones revisadas.</div>';return;}
rev.forEach(m=>el.appendChild(buildCard(m,false)));
}

function buildCard(m,isPendiente){
const card=document.createElement('div');card.className='card';
const safeId=m.id.replace(/:/g,'-').replace(/\./g,'-');
card.id='card-'+safeId;
let urls=(m.fotos_uris||'').split(';').filter(Boolean);
// Eliminar duplicados de URLs
urls=[...new Set(urls)];
// Convertir URLs de Drive a formato de thumbnail directo
urls=urls.map(u=>{
if(u.includes('drive.google.com')){
// Extraer ID de diferentes formatos de URL de Drive
let fileId=null;
if(u.includes('/d/')){
const match=u.match(/\/d\/([^\/\?]+)/);
if(match)fileId=match[1];
}else if(u.includes('id=')){
const match=u.match(/id=([^&]+)/);
if(match)fileId=match[1];
}else if(u.includes('/file/d/')){
const match=u.match(/\/file\/d\/([^\/\?]+)/);
if(match)fileId=match[1];
}
if(fileId)return `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
}
return u;
});

// Vista compacta inicial
card.innerHTML=`
<div style="display:flex;justify-content:space-between;align-items:center;">
<div>
<h2 style="margin:0 0 8px 0;">${m.activo||'Sin Activo'} <small style="color:var(--muted);">(${m.proveedor||''})</small></h2>
<div style="display:flex;gap:16px;font-size:14px;color:var(--muted);">
<span><strong>Clasificaci√≥n:</strong> ${m.clasificacion||''}</span>
<span><strong>Fotos:</strong> ${urls.length||0}</span>
<span><strong>Fecha:</strong> ${m.fecha_medicion?new Date(m.fecha_medicion).toLocaleDateString('es-ES'):''}</span>
</div>
</div>
<button onclick="toggleDetalle('${safeId}',${isPendiente},'${m.id}')" style="background:var(--accent);padding:8px 16px;white-space:nowrap;">üëÅÔ∏è Ver</button>
</div>
<div id="detalle-${safeId}" style="display:none;margin-top:16px;border-top:1px solid #263158;padding-top:16px;">
<!-- El detalle se carga al hacer clic en Ver -->
</div>
`;
return card;
}

function toggleDetalle(safeId,isPendiente,originalId){
const detalle=document.getElementById('detalle-'+safeId);
const card=document.getElementById('card-'+safeId);
const btn=card?card.querySelector('button'):null;
if(!detalle||!btn)return;
if(detalle.style.display==='none'){
// Expandir - cargar detalle
const m=mediciones.find(x=>x.id===originalId);
if(!m)return;
let urls=(m.fotos_uris||'').split(';').filter(Boolean);
urls=[...new Set(urls)];
urls=urls.map(u=>{
if(u.includes('drive.google.com')){
let fileId=null;
if(u.includes('/d/')){const match=u.match(/\/d\/([^\/\?]+)/);if(match)fileId=match[1];}
else if(u.includes('id=')){const match=u.match(/id=([^&]+)/);if(match)fileId=match[1];}
else if(u.includes('/file/d/')){const match=u.match(/\/file\/d\/([^\/\?]+)/);if(match)fileId=match[1];}
if(fileId)return `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
}
return u;
});

let fotoHtml='';
if(urls.length){
const mainId='main-'+m.id.replace(/:/g,'').replace(/\./g,'');
const thumbsHtml=urls.map((u,i)=>`<img class="thumb ${i===0?'selected':''}" src="${u}" data-main="${mainId}" data-idx="${i}" onclick="selectFoto(this)"/>`).join('');
const compareBtn=urls.length>=2?`<button class="secondary" onclick="toggleComparador('compare-${safeId}',${JSON.stringify(urls).replace(/"/g,'&quot;')})">üîç Comparar Fotos</button>`:'';
fotoHtml=`
<div class="foto-viewer">
<img id="${mainId}" class="foto-main" src="${urls[0]}" onclick="toggleZoom(this)"/>
<div class="foto-thumbs">${thumbsHtml}</div>
${compareBtn}
</div>
<div id="compare-${safeId}" class="foto-compare" style="display:none;">
<div><img id="compare-left-${safeId}" src="${urls[0]}" onclick="toggleZoom(this)"/><p style="text-align:center;margin:4px 0;"><select onchange="updateCompare('left','${safeId}',this.value)">${urls.map((u,i)=>`<option value="${i}">Foto ${i+1}</option>`).join('')}</select></p></div>
<div><img id="compare-right-${safeId}" src="${urls[Math.min(1,urls.length-1)]}" onclick="toggleZoom(this)"/><p style="text-align:center;margin:4px 0;"><select onchange="updateCompare('right','${safeId}',this.value)">${urls.map((u,i)=>`<option value="${i}" ${i===Math.min(1,urls.length-1)?'selected':''}}>Foto ${i+1}</option>`).join('')}</select></p></div>
</div>
`;
}

detalle.innerHTML=`
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
<div><strong>Clasificaci√≥n:</strong> ${m.clasificacion||''}</div>
<div><strong>Fecha:</strong> ${m.fecha_medicion?new Date(m.fecha_medicion).toLocaleString('es-ES'):''}</div>
<div><strong>Fotos:</strong> ${urls.length||0}</div>
<div><strong>GPS:</strong> ${m.gps_lat?parseFloat(m.gps_lat).toFixed(6)+', '+parseFloat(m.gps_lng).toFixed(6):'Sin GPS'}</div>
</div>
${fotoHtml}
<div class="form-group">
<label>Valor de medici√≥n:</label>
<input id="valor-${m.id}" type="text" placeholder="Ej: -22.45" maxlength="6" value="${m.valor_medicion||''}" ${!isPendiente?'readonly':''} style="font-family: monospace;"/>
<small style="color:var(--muted);display:block;margin-top:4px;">Formato: -23.50 a 5.00 (ej: -22.45)</small>
</div>
<div class="form-group"><label>Notas/Comentarios del proveedor:</label><textarea readonly>${m.notas_texto||'Sin comentarios'}</textarea></div>
${isPendiente?`
<div class="form-group"><label>Comentario de revisi√≥n:</label><textarea id="comentario-${m.id}" placeholder="Opcional al aprobar, requerido al rechazar"></textarea></div>
<div class="actions">
<button class="success" onclick="aprobar('${m.id}')">‚úÖ Medici√≥n OK</button>
<button class="danger" onclick="rechazar('${m.id}')">‚ùå Rechazar</button>
</div>
`:''}
`;
detalle.style.display='block';
btn.innerHTML='üîº Ocultar';
}else{
// Contraer
detalle.style.display='none';
detalle.innerHTML='';
btn.innerHTML='üëÅÔ∏è Ver';
}
}

function selectFoto(img){
const mainId=img.dataset.main;
const mainImg=document.getElementById(mainId);
mainImg.src=img.src;
img.parentElement.querySelectorAll('.thumb').forEach(t=>t.classList.remove('selected'));
img.classList.add('selected');
}

// Zoom en fotos
function toggleZoom(img){
img.classList.toggle('zoomed');
}

// Comparador de fotos
let comparadorUrls=[];
function toggleComparador(compareId,urls){
if(typeof urls==='string')urls=JSON.parse(urls.replace(/&quot;/g,'"'));
comparadorUrls=urls;
const div=document.getElementById(compareId);
if(div){
div.style.display=div.style.display==='none'?'grid':'none';
}
}

function updateCompare(side,safeId,idx){
const img=document.getElementById(`compare-${side}-${safeId}`);
if(img&&comparadorUrls[idx]){
img.src=comparadorUrls[idx];
}
}

async function aprobar(id){
const valorEl=document.getElementById('valor-'+id);
const comentarioEl=document.getElementById('comentario-'+id);
const valor=valorEl?valorEl.value.trim():'';
const comentario=comentarioEl?comentarioEl.value.trim():'';

// Validar formato de medici√≥n
const validacion = validarMedicion(valor);
if (!validacion.valido) {
	alert(validacion.mensaje);
	valorEl?.focus();
	return;
}

const m=mediciones.find(x=>x.id===id);if(!m)return;
const audit=m.audit||[];
audit.push({timestamp:new Date().toISOString(),actor:'verificador',action:'APROBADO',details:comentario||'Sin comentarios'});
await fbDb.collection('mediciones').doc(id).update({estado:'medido',valor_medicion:valor,audit});
}

async function rechazar(id){
const comentarioEl=document.getElementById('comentario-'+id);
const comentario=comentarioEl?comentarioEl.value.trim():'';
if(!comentario){alert('Debes ingresar un comentario al rechazar.');return;}
if(!confirm('¬øRechazar esta medici√≥n? Volver√° a pendientes del proveedor.')){return;}
const m=mediciones.find(x=>x.id===id);if(!m)return;

// Borrar fotos de Drive
const urls=(m.fotos_uris||'').split(';').filter(Boolean);
for(const url of urls){
try{
let fileId=null;
if(url.includes('/d/')){
const match=url.match(/\/d\/([^\/\?]+)/);
if(match)fileId=match[1];
}else if(url.includes('id=')){
const match=url.match(/id=([^&]+)/);
if(match)fileId=match[1];
}else if(url.includes('/file/d/')){
const match=url.match(/\/file\/d\/([^\/\?]+)/);
if(match)fileId=match[1];
}
if(fileId){
const formData=new FormData();
formData.append('action','deleteFile');
formData.append('fileId',fileId);
await fetch(WEBAPP_URL,{method:'POST',body:formData});
}
}catch(e){console.warn('Error borrando foto',url,e);}
}

const audit=m.audit||[];
audit.push({timestamp:new Date().toISOString(),actor:'verificador',action:'RECHAZADO',details:comentario});

// Crear nota con el rechazo para que se muestre en la web del contratista
const nota={type:'rechazo',text:comentario,timestamp:new Date().toISOString()};

await fbDb.collection('mediciones').doc(id).update({
estado:'pendiente',
fotos_uris:'',
fotos_cantidad:0,
audit,
observacion_rechazo:comentario,
fecha_rechazo:new Date().toISOString()
});
}

async function exportarRevision(){
const from=document.getElementById('exportFrom').value;
const to=document.getElementById('exportTo').value;
let rev=mediciones.filter(m=>m.estado==='medido');
if(from)rev=rev.filter(m=>m.fecha_medicion>=from);
if(to)rev=rev.filter(m=>m.fecha_medicion<=to);
if(!rev.length){alert('No hay mediciones en el rango seleccionado.');return;}

const btnExport=document.querySelector('button[onclick="exportarRevision()"]');
if(btnExport)btnExport.disabled=true;
const originalText=btnExport?btnExport.textContent:'';
if(btnExport)btnExport.textContent='‚è≥ Descargando fotos...';

const zip=new JSZip();
const csvRows=[['Proveedor','Activo','Clasificacion','Fecha','Valor','Fotos','GPS_Lat','GPS_Lng','Notas']];
let totalFotos=0;
let fotosDescargadas=0;

// Contar total de fotos
for(const m of rev){
const urls=(m.fotos_uris||'').split(';').filter(Boolean);
totalFotos+=urls.length;
}

for(const m of rev){
csvRows.push([m.proveedor||'',m.activo||'',m.clasificacion||'',m.fecha_medicion||'',m.valor_medicion||'',m.fotos_cantidad||'',m.gps_lat||'',m.gps_lng||'',m.notas_texto||'']);
const urls=(m.fotos_uris||'').split(';').filter(Boolean);
for(let i=0;i<urls.length;i++){
try{
// Extraer fileId de la URL de Drive
let fileId=null;
const url=urls[i];
if(url.includes('/d/')){
const match=url.match(/\/d\/([^\/\?]+)/);
if(match)fileId=match[1];
}else if(url.includes('id=')){
const match=url.match(/id=([^&]+)/);
if(match)fileId=match[1];
}else if(url.includes('/file/d/')){
const match=url.match(/\/file\/d\/([^\/\?]+)/);
if(match)fileId=match[1];
}

if(fileId){
// Descargar foto via Apps Script
const formData=new FormData();
formData.append('action','downloadFile');
formData.append('fileId',fileId);
const resp=await fetch(WEBAPP_URL,{method:'POST',body:formData});
if(resp.ok){
const result=await resp.json();
if(result.success&&result.base64Data){
// Convertir base64 a blob
const binaryString=atob(result.base64Data);
const bytes=new Uint8Array(binaryString.length);
for(let j=0;j<binaryString.length;j++){
bytes[j]=binaryString.charCodeAt(j);
}
const blob=new Blob([bytes],{type:result.contentType||'image/jpeg'});
// Obtener extensi√≥n del contentType
let ext='jpg';
const contentType=result.contentType||'image/jpeg';
if(contentType.includes('png'))ext='png';
else if(contentType.includes('jpeg')||contentType.includes('jpg'))ext='jpg';
else if(contentType.includes('webp'))ext='webp';
else if(contentType.includes('gif'))ext='gif';
			// Generar nombre de archivo seg√∫n clasificaci√≥n
			let nombreArchivo;
			const pd = m.activo.substring(0, 4); // Primeras 4 letras = PD
			const medicion = m.valor_medicion || '0.00';
			
			if (m.clasificacion === 'CDO') {
				// CDO: {activo} _ CDO _ {medicion}.jpg
				nombreArchivo = `${m.activo} _ CDO _ ${medicion}.${ext}`;
			} else {
				// NAP: {activo} _ NAP - {descripcion} _ {medicion}.jpg
				// Para NAP, usar la descripci√≥n del activo o "foto{i+1}" si no hay descripci√≥n
				const descripcion = m.activo.length > 4 ? m.activo.substring(4) : `foto${i+1}`;
				nombreArchivo = `${m.activo} _ NAP - ${descripcion} _ ${medicion}.${ext}`;
			}
			
			zip.file(`${pd}/${nombreArchivo}`, blob);
fotosDescargadas++;
if(btnExport)btnExport.textContent=`‚è≥ Descargando ${fotosDescargadas}/${totalFotos}...`;
}else{
console.warn('Error en respuesta del Apps Script:',result);
}
}else{
console.warn('Error descargando foto',fileId,resp.status);
}
}
}catch(e){console.warn('Error descargando foto',e);}
}
}

if(btnExport)btnExport.textContent='‚è≥ Generando ZIP...';
const csv=csvRows.map(r=>r.map(c=>`"${c}"`).join(',')).join('\n');
zip.file('mediciones.csv',csv);
const content=await zip.generateAsync({type:'blob'});
saveAs(content,`revision_${new Date().toISOString().split('T')[0]}.zip`);

if(btnExport){
btnExport.disabled=false;
btnExport.textContent=originalText;
}
}

// Exportar a PDF con fotos
async function exportarPDF(){
const from=document.getElementById('exportFrom').value;
const to=document.getElementById('exportTo').value;
let rev=mediciones.filter(m=>m.estado==='medido');
if(from)rev=rev.filter(m=>m.fecha_medicion>=from);
if(to)rev=rev.filter(m=>m.fecha_medicion<=to);
if(!rev.length){alert('No hay mediciones en el rango seleccionado.');return;}

const btnPDF=document.querySelector('button[onclick="exportarPDF()"]');
if(btnPDF)btnPDF.disabled=true;
const originalText=btnPDF?btnPDF.textContent:'';
if(btnPDF)btnPDF.textContent='‚è≥ Generando PDF...';

try{
const{jsPDF}=window.jspdf;
const doc=new jsPDF();
let y=20;

// Logo y t√≠tulo
doc.setFontSize(20);
doc.setTextColor(0,169,224);
doc.text('Personal - Mediciones ODN',105,y,{align:'center'});
y+=15;

doc.setFontSize(10);
doc.setTextColor(0,0,0);
doc.text(`Reporte de Mediciones - ${new Date().toLocaleDateString('es-ES')}`,105,y,{align:'center'});
y+=10;

for(const m of rev){
if(y>270){doc.addPage();y=20;}

// Box para cada medici√≥n
doc.setDrawColor(0,169,224);
doc.setLineWidth(0.5);
doc.rect(10,y,190,40);

doc.setFontSize(12);
doc.setFont(undefined,'bold');
doc.text(`${m.activo||'N/A'}`,15,y+7);

doc.setFont(undefined,'normal');
doc.setFontSize(9);
doc.text(`Proveedor: ${m.proveedor||''}`,15,y+14);
doc.text(`Clasificaci√≥n: ${m.clasificacion||''}`,15,y+20);
doc.text(`Valor: ${m.valor_medicion||'N/A'}`,15,y+26);
doc.text(`Fecha: ${m.fecha_medicion?new Date(m.fecha_medicion).toLocaleDateString('es-ES'):''}`,15,y+32);

if(m.gps_lat){
doc.text(`GPS: ${parseFloat(m.gps_lat).toFixed(6)}, ${parseFloat(m.gps_lng).toFixed(6)}`,100,y+14);
}

doc.text(`Fotos: ${(m.fotos_uris||'').split(';').filter(Boolean).length}`,100,y+20);

y+=45;
}

doc.save(`mediciones_${new Date().toISOString().split('T')[0]}.pdf`);
}catch(e){
console.error('Error generando PDF:',e);
alert('Error al generar PDF: '+e.message);
}finally{
if(btnPDF){
btnPDF.disabled=false;
btnPDF.textContent=originalText;
}
}
}
</script>
</body>
</html>